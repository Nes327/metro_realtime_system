<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Metro Realtime â€” Route & Fare</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    :root { --bg:#0b0c0f; --card:#fff; --muted:#666; --accent:#10b981; }
    html,body{margin:0;padding:0;background:#f7f7f8;color:#111;font-family:system-ui,Segoe UI,Roboto,Arial}
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
    h1{font-weight:800;letter-spacing:.5px;margin:0 0 8px}
    .sub{color:#555;margin:0 0 18px}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media(min-width:980px){ .grid{grid-template-columns:1fr 1fr;gap:16px}}
    .card{background:var(--card);border-radius:16px;box-shadow:0 6px 24px rgba(0,0,0,.08);padding:16px}
    label{display:block;font-size:14px;color:#444;margin:6px 0}
    select, input[type="text"]{
      width:100%;padding:10px 12px;border:1px solid #e3e3e7;border-radius:10px;
      font-size:15px;background:#fff;outline:none;
    }
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .radio{display:flex;gap:10px;align-items:center}
    button{
      padding:10px 14px;border-radius:12px;border:0;background:#111;color:#fff;
      cursor:pointer;font-weight:600;letter-spacing:.3px
    }
    button:disabled{opacity:.5;cursor:not-allowed}
    .muted{color:var(--muted);font-size:14px}
    .pill{display:inline-block;padding:6px 10px;border-radius:999px;background:#111;color:#fff;font-size:12px}
    .path{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .chip{background:#111;color:#fff;border-radius:999px;padding:6px 10px;font-size:13px}
    .arrow{opacity:.3}
    .error{background:#ffe1e1;border:1px solid #ffc5c5;color:#8a1a1a;padding:10px;border-radius:10px}
    .ok{background:#e9fff4;border:1px solid #b6f3d6;color:#0a6b49;padding:10px;border-radius:10px}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}
    .wsbox{background:#0f1115;color:#8bf0c8;border-radius:12px;padding:10px;font-size:12px;min-height:100px;white-space:pre-wrap}
    .bar{background:#e5e7eb;border-radius:8px;overflow:hidden;height:14px;margin-bottom:6px}
    .bar > div{background:var(--accent);height:100%;width:0%}
    #map{height:360px;border-radius:12px;border:1px solid #e5e7eb}
    .train-icon{
      background:#111;color:#fff;border-radius:999px;padding:4px 8px;font-size:12px;
      border:2px solid #fff; box-shadow:0 2px 6px rgba(0,0,0,.2)
    }
    .chip.active{background:#047857!important}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Metro Realtime â€” Route Planner</h1>
    <p class="sub">é€‰æ‹©èµ·ç‚¹ä¸ç»ˆç‚¹ï¼Œè§„åˆ’è·¯çº¿å¹¶æŸ¥çœ‹ç¥¨ä»·ï¼›åœ°å›¾é«˜äº®çº¿è·¯ï¼Œå°ç«è½¦æ²¿æ®µç§»åŠ¨ï¼ˆæ— åæ ‡ä¹Ÿèƒ½æ¼”ç¤ºï¼‰ã€‚</p>

    <div class="grid">
      <!-- å·¦ï¼šè§„åˆ’ + åœ°å›¾ -->
      <div class="card">
        <div class="grid">
          <div>
            <label for="fromSel">Fromï¼ˆèµ·ç‚¹ï¼‰</label>
            <select id="fromSel"></select>
          </div>
          <div>
            <label for="toSel">Toï¼ˆç»ˆç‚¹ï¼‰</label>
            <select id="toSel"></select>
          </div>
        </div>

        <div class="row" style="margin:12px 0 4px">
          <div class="radio">
            <input type="radio" name="mode" id="mStops" value="stops" checked />
            <label for="mStops">æœ€å°‘ç«™æ•° (stops)</label>
          </div>
          <div class="radio">
            <input type="radio" name="mode" id="mTime" value="time" />
            <label for="mTime">æœ€çŸ­æ—¶é—´ (time)</label>
          </div>
          <button id="swapBtn" title="äº¤æ¢èµ·ç»ˆç‚¹">â‡„ äº¤æ¢</button>
          <button id="planBtn">è§„åˆ’è·¯çº¿</button>
          <button id="simBtn" style="background:#2563eb">å¼€å§‹æ¨¡æ‹Ÿåˆ—è½¦</button>
          <button id="stopBtn" style="background:#9a3412">åœæ­¢æ‰€æœ‰åˆ—è½¦</button>
        </div>

        <p class="muted">æ•°æ®æ¥è‡ª <span class="mono">/stations</span>ã€<span class="mono">/route_by_name</span>ã€<span class="mono">/fare_by_name</span>ï¼›å®æ—¶æ¥è‡ª <span class="mono">/ws</span>ã€‚</p>

        <div id="result" style="margin-top:10px"></div>

        <div style="margin-top:10px">
          <div class="bar"><div id="totalBar" style="width:0%"></div></div>
          <div class="muted">å…¨ç¨‹è¿›åº¦ <span id="totalPct">0%</span></div>
        </div>

        <div id="map" style="margin-top:12px"></div>
      </div>

      <!-- å³ï¼šWebSocket æ—¥å¿— -->
      <div class="card">
        <div class="row" style="justify-content:space-between">
          <strong>Realtime (WebSocket)</strong>
          <span id="wsStatus" class="pill">connectingâ€¦</span>
        </div>
        <div class="wsbox" id="wsLog"></div>
        <div class="row" style="margin-top:8px">
          <input id="wsMsg" type="text" placeholder="type to echoâ€¦" />
          <button id="wsSend">Send</button>
        </div>
        <p class="muted" style="margin-top:6px">æ­¤åŒºåŸŸç”¨äºç¡®è®¤å®æ—¶é€šé“ï¼›åœ°å›¾å’Œè·¯çº¿ chips ä¼šåŒæ­¥é«˜äº®ã€‚</p>
      </div>
    </div>
  </div>

  <script>
    // ---------------- DOM refs ----------------
    const $ = (sel)=>document.querySelector(sel);
    const fromSel = $('#fromSel');
    const toSel   = $('#toSel');
    const planBtn = $('#planBtn');
    const swapBtn = $('#swapBtn');
    const result  = $('#result');
    const simBtn  = $('#simBtn');
    const stopBtn = $('#stopBtn');
    const totalBar = $('#totalBar');
    const totalPct = $('#totalPct');

    // ---------------- Leaflet ----------------
    const map = L.map('map').setView([3.139, 101.6869], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
      attribution:'&copy; OpenStreetMap contributors'
    }).addTo(map);

    const stationCoords = new Map(); // name(lower) -> {lat,lng}
    let routeLine = null;
    const trains = new Map(); // id -> {marker}
    const trainIcon = (id)=> L.divIcon({ className:'train-icon', html:`ğŸš† ${id}`, iconSize:[40,20], iconAnchor:[20,10] });

    const activeRoute = {
      pathNames: [],
      geom: [],              // å½“å‰è·¯å¾„çš„åæ ‡åºåˆ—ï¼ˆçœŸåæ ‡æˆ–ä¸´æ—¶è½¨é“ï¼‰
      nameToLL: new Map(),   // name(lower) -> {lat,lng}ï¼ˆçœŸåæ ‡æˆ–ä¸´æ—¶ï¼‰
    };

    function showError(msg){ result.innerHTML = `<div class="error">${msg}</div>`; }
    function showOk(html){ result.innerHTML = `<div class="ok">${html}<div class="path" id="pathChips" style="margin-top:10px"></div></div>`; }

    // ---------------- 1) åŠ è½½ç«™ç‚¹ ----------------
    async function loadStations(){
      fromSel.innerHTML = '<option>Loadingâ€¦</option>';
      toSel.innerHTML   = '<option>Loadingâ€¦</option>';
      const res = await fetch('/stations');
      const js  = await res.json();
      const names = (js.data || []).map(s=>s.name);
      const opts = names.map(n=>`<option value="${n}">${n}</option>`).join('');
      fromSel.innerHTML = `<option value="">é€‰æ‹©èµ·ç‚¹</option>` + opts;
      toSel.innerHTML   = `<option value="">é€‰æ‹©ç»ˆç‚¹</option>` + opts;

      const trySet = (sel, name)=>{
        const opt = Array.from(sel.options).find(o=>o.value.toLowerCase()===name.toLowerCase());
        if(opt) sel.value = opt.value;
      };
      trySet(fromSel, 'KLCC');
      trySet(toSel, 'Kajang');

      let anyCoords = false;
      (js.data || []).forEach(s=>{
        if(s.latitude!=null && s.longitude!=null){
          anyCoords = true;
          stationCoords.set(s.name.toLowerCase(), {lat: s.latitude, lng: s.longitude});
          L.circleMarker([s.latitude, s.longitude], {
            radius:4, weight:1, color:'#111', fillColor:'#111', fillOpacity:.9
          }).bindTooltip(s.name).addTo(map);
        }
      });
      if(!anyCoords){
        console.log('[map] no station coordinates in DB; will use synthetic geometry per route.');
      }
    }

    // ---------------- 2) UI ----------------
    swapBtn.onclick = ()=>{
      const a = fromSel.value;
      fromSel.value = toSel.value;
      toSel.value = a;
    };
    const getMode = ()=>document.querySelector('input[name="mode"]:checked').value;

    // ---------------- 3) è§„åˆ’è·¯çº¿ ----------------
    planBtn.onclick = async ()=>{
      const from = fromSel.value.trim();
      const to   = toSel.value.trim();
      const mode = getMode();
      if(!from || !to){ showError('è¯·é€‰æ‹©èµ·ç‚¹ä¸ç»ˆç‚¹'); return; }
      planBtn.disabled = true; planBtn.textContent = 'è§„åˆ’ä¸­â€¦';

      try {
        const rUrl = `/route_by_name?from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}&mode=${encodeURIComponent(mode)}`;
        const fUrl = `/fare_by_name?from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}`;
        const [rRes, fRes] = await Promise.all([fetch(rUrl), fetch(fUrl)]);
        const rJs = await rRes.json();
        const fJs = await fRes.json();
        if(!rRes.ok){ showError(`æ‰¾ä¸åˆ°è·¯çº¿ï¼ˆ${from} â†’ ${to}ï¼Œmode=${mode}ï¼‰`); return; }

        const path = rJs.path_names || [];
        activeRoute.pathNames = path;

        const chipsHtml = path.map((p,i)=> i===path.length-1
          ? `<span class="chip">${p}</span>`
          : `<span class="chip">${p}</span><span class="arrow">â†’</span>`).join(' ');
        showOk(`ä» <b>${from}</b> åˆ° <b>${to}</b>ï¼Œæ¨¡å¼ <code>${mode}</code>ï¼š<br>
                é€”ç» <b>${rJs.total_stops}</b> ç«™${(mode==='time'&&rJs.total_time!=null)?`ï¼Œæ€»æ—¶é—´ <b>${rJs.total_time}</b> åˆ†é’Ÿ`:''}
                ${(fRes.ok&&fJs.price!=null)?`ï¼Œç¥¨ä»· <b>RM ${Number(fJs.price).toFixed(2)}</b>`:'ï¼Œç¥¨ä»·æš‚æ— '}`);
        $('#pathChips').innerHTML = chipsHtml;

        // æ„å»ºå‡ ä½•ï¼ˆä¼˜å…ˆçœŸåæ ‡ï¼›å¦åˆ™ç”Ÿæˆä¸´æ—¶ç›´çº¿å‡ ä½•ï¼‰
        buildRouteGeometry(path);

        // ç”» polyline
        if(routeLine){ map.removeLayer(routeLine); routeLine = null; }
        if(activeRoute.geom.length >= 2){
          routeLine = L.polyline(activeRoute.geom, {color:'#10b981', weight:5, opacity:.85}).addTo(map);
          map.fitBounds(routeLine.getBounds(), {padding:[30,30]});
        }

        // å¤ä½è¿›åº¦æ¡
        totalBar.style.width = '0%';
        totalPct.textContent = '0%';

      } catch (e){
        console.error(e);
        showError('è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æ˜¯å¦è¿è¡Œ');
      } finally {
        planBtn.disabled = false; planBtn.textContent = 'è§„åˆ’è·¯çº¿';
      }
    };

    // æ„å»ºå½“å‰è·¯å¾„çš„å‡ ä½•ï¼šæœ‰åæ ‡â†’ä½¿ç”¨ï¼›å¦åˆ™â†’ç”Ÿæˆä¸´æ—¶ç›´çº¿è½¨é“
    function buildRouteGeometry(path){
      activeRoute.geom = [];
      activeRoute.nameToLL = new Map();

      // å…ˆçœ‹æ˜¯å¦æ‰€æœ‰ç«™éƒ½æœ‰çœŸå®åæ ‡
      const real = [];
      let allHave = true;
      for(const n of path){
        const c = stationCoords.get(n.toLowerCase());
        if(!c){ allHave = false; break; }
        real.push([c.lat, c.lng]);
        activeRoute.nameToLL.set(n.toLowerCase(), {lat:c.lat,lng:c.lng});
      }
      if(allHave && real.length>=2){
        activeRoute.geom = real;
        return;
      }

      // ç”Ÿæˆä¸´æ—¶å‡ ä½•ï¼šæŒ‰è·¯å¾„ç«™æ•°åœ¨çº¿æ€§æ’å€¼ä¸€æ¡çº¿
      // é€‰æ‹©ä¸¤ç«¯é”šç‚¹ï¼ˆå¯å¾®è°ƒè®©çº¿æ¡æ›´ç¾è§‚ï¼‰
      const A = L.latLng(3.20, 101.64);
      const B = L.latLng(3.00, 101.76);
      const N = Math.max(2, path.length);
      for(let i=0;i<N;i++){
        const t = (N===1)?0:(i/(N-1));
        const lat = A.lat + (B.lat - A.lat)*t;
        const lng = A.lng + (B.lng - A.lng)*t;
        const name = path[i];
        activeRoute.geom.push([lat,lng]);
        activeRoute.nameToLL.set(name.toLowerCase(), {lat,lng});
      }
    }

    // ---------------- 4) å†…ç½®æ¨¡æ‹Ÿï¼ˆå¯é€‰ï¼‰ ----------------
    simBtn.onclick = async ()=>{
      const from = fromSel.value.trim();
      const to   = toSel.value.trim();
      if(!from || !to){ showError('è¯·é€‰æ‹©èµ·ç‚¹ä¸ç»ˆç‚¹'); return; }
      simBtn.disabled = true; simBtn.textContent = 'å¯åŠ¨ä¸­â€¦';
      try{
        const resp = await fetch('/simulate_train', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ from, to, mode: 'time', speed: 6, loop: true, ping_interval: 1 })
        });
        const js = await resp.json();
        if(!resp.ok){ showError('å¯åŠ¨å¤±è´¥ï¼š' + (js.error || '')); }
        else{ log(`[train] ${js.train_id} started (built-in)`); }
      }catch(e){ showError('è¯·æ±‚å¤±è´¥'); }
      finally{ simBtn.disabled = false; simBtn.textContent = 'å¼€å§‹æ¨¡æ‹Ÿåˆ—è½¦'; }
    };

    stopBtn.onclick = async ()=>{
      try{
        const list = await fetch('/trains').then(r=>r.json());
        const ids = list.trains || [];
        await Promise.all(ids.map(id=>fetch('/trains/'+encodeURIComponent(id), {method:'DELETE'})));
        log('stopped all built-in trains');
      }catch(e){ showError('åœæ­¢å¤±è´¥'); }
    };

    // ---------------- 5) WebSocket ----------------
    const ws = new WebSocket(`ws://${location.host}/ws`);
    const wsStatus = $('#wsStatus');
    const wsLog = $('#wsLog');
    const log = (t)=>{ wsLog.textContent += t + "\n"; wsLog.scrollTop = wsLog.scrollHeight; };
    $('#wsSend').onclick = ()=>{ if(ws.readyState===1){ ws.send($('#wsMsg').value||''); } };
    ws.addEventListener('open', ()=>{ wsStatus.textContent='connected'; wsStatus.style.background='#0a6b49'; log('[ws] open'); });
    ws.addEventListener('close', ()=>{ wsStatus.textContent='closed'; wsStatus.style.background='#999'; log('[ws] close'); });
    ws.addEventListener('error', ()=>{ wsStatus.textContent='error'; wsStatus.style.background='#b33'; log('[ws] error'); });

    ws.addEventListener('message', (ev)=>{
      try{
        const js = JSON.parse(ev.data);
        if(js.type === 'hello'){ log('[ws] ' + js.msg); return; }

        if(js.type === 'train_tick'){
          log(`[train] ${js.train_id}: ${js.origin} â†’ ${js.dest} ${(js.progress*100).toFixed(0)}%`);
          updateChips(js.origin, js.dest);
          updateTotalProgress(js.origin, js.dest, js.progress);
          moveTrain(js.train_id, js.origin, js.dest, js.progress);
          return;
        }
        if(js.type === 'train_update'){
          log(`[update] ${js.train_id}: ${js.from} â†’ ${js.to} ${(js.progress*100).toFixed(0)}%`);
          updateChips(js.from, js.to);
          updateTotalProgress(js.from, js.to, js.progress);
          moveTrain(js.train_id, js.from, js.to, js.progress);
          return;
        }
        log('[ws] ' + ev.data);
      }catch(e){ log('[ws] ' + ev.data); }
    });

    // ---------------- 6) é«˜äº® chips + æ€»è¿›åº¦ ----------------
    function updateChips(origin, dest){
      const pathBox = document.getElementById('pathChips');
      if(!pathBox) return;
      const chips = [...pathBox.querySelectorAll('.chip')];
      chips.forEach(ch=>ch.classList.remove('active'));
      chips.forEach((ch,i)=>{
        const name = ch.textContent.trim().toLowerCase();
        if(name===String(origin).toLowerCase() || name===String(dest).toLowerCase()){
          ch.classList.add('active');
        }
      });
    }

    function updateTotalProgress(origin, dest, segProgress){
      const path = activeRoute.pathNames || [];
      if(path.length < 2) return;
      const i1 = path.findIndex(n=>n.toLowerCase()===String(origin).toLowerCase());
      const i2 = path.findIndex(n=>n.toLowerCase()===String(dest).toLowerCase());
      if(i1<0 || i2<0) return;
      const done = Math.min(i1, i2);
      const totalSeg = path.length - 1;
      let pct = ((done + Math.max(0,Math.min(1,segProgress))) / totalSeg) * 100;
      pct = Math.max(0, Math.min(100, pct));
      totalBar.style.width = pct.toFixed(1) + '%';
      totalPct.textContent = pct.toFixed(1) + '%';
    }

    // ---------------- 7) å°ç«è½¦ç§»åŠ¨ï¼ˆæ”¯æŒçœŸåæ ‡æˆ–ä¸´æ—¶è½¨é“ï¼‰ ----------------
    function moveTrain(trainId, origin, dest, segProgress){
      // å…ˆä»å½“å‰è·¯å¾„å->åæ ‡è¡¨é‡Œå–
      const a = activeRoute.nameToLL.get(String(origin).toLowerCase());
      const b = activeRoute.nameToLL.get(String(dest).toLowerCase());
      if(!a || !b){
        // å¦‚æœè¿˜æ²¡è§„åˆ’è·¯çº¿ï¼Œå°è¯•ç”¨å…¨å±€ç«™ç‚¹åæ ‡ï¼ˆè‹¥æœ‰ï¼‰
        const aa = stationCoords.get(String(origin).toLowerCase());
        const bb = stationCoords.get(String(dest).toLowerCase());
        if(!aa || !bb) return; // æ— åæ ‡ä¹Ÿæ— ä¸´æ—¶å‡ ä½•ï¼Œç›´æ¥è¿”å›ï¼ˆchips/è¿›åº¦ä»ä¼šåŠ¨ï¼‰
        const lat = aa.lat + (bb.lat-aa.lat) * Math.max(0,Math.min(1,segProgress));
        const lng = aa.lng + (bb.lng-aa.lng) * Math.max(0,Math.min(1,segProgress));
        placeTrain(trainId, lat, lng);
        return;
      }
      const lat = a.lat + (b.lat-a.lat) * Math.max(0,Math.min(1,segProgress));
      const lng = a.lng + (b.lng-a.lng) * Math.max(0,Math.min(1,segProgress));
      placeTrain(trainId, lat, lng);
    }

    function placeTrain(id, lat, lng){
      let t = trains.get(id);
      if(!t){
        t = {marker: L.marker([lat,lng], {icon: trainIcon(id)}).addTo(map)};
        trains.set(id, t);
      }else{
        t.marker.setLatLng([lat,lng]);
      }
    }

    // åˆå§‹åŠ è½½
    loadStations();
  </script>
</body>
</html>
